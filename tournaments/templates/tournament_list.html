{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Find Your Tournament</title>
{% endblock meta %}

{% block content %}
<div class="bg-[#0b0b23] min-h-screen text-white pt-20 pb-10">
  <div class="max-w-7xl mx-auto px-6">
    <div class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-wide mb-4">
        FIND YOUR PERFECT TOURNAMENT
      </h1>
      <div class="flex justify-center gap-3 mt-4">
        <button id="allBtn" class="px-5 py-2 bg-yellow-400 text-black rounded-full font-bold transition">
          All Tournaments
        </button>

        {% if user.is_authenticated %}
          <button id="myBtn" class="px-5 py-2 bg-gray-700 rounded-full font-semibold hover:bg-yellow-400 hover:text-black transition">
            My Tournaments
          </button>
        {% endif %}

        {% if is_coach %}
          <a href="{% url 'tournaments:create_tournament' %}"
             class="ml-4 px-5 py-2 bg-green-500 rounded-full font-semibold hover:bg-green-600 transition">
            + Create Tournament
          </a>
        {% endif %}
      </div>
    </div>
    <div class="relative mb-10 flex justify-center">
      <input id="searchInput" type="text" placeholder="Search Tournament or Location"
        class="w-full md:w-2/3 bg-[#1b1b3a] border border-gray-700 rounded-xl py-3 px-4 pl-12 text-gray-300 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400" />
      <svg xmlns="http://www.w3.org/2000/svg"
        class="w-5 h-5 absolute left-[calc(50%-33%)] top-1/2 -translate-y-1/2 text-gray-400"
        fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M21 21l-4.35-4.35M17 10a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    <div id="tournamentGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
    </div>
    <div id="emptyState" class="hidden text-center mt-10 text-gray-400">
      <p>No tournaments found.</p>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const grid = document.getElementById("tournamentGrid");
  const searchInput = document.getElementById("searchInput");
  const emptyState = document.getElementById("emptyState");
  const allBtn = document.getElementById("allBtn");
  const myBtn = document.getElementById("myBtn");

  let tournaments = [];
  async function loadTournaments() {
    try {
      const response = await fetch(window.location.href, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      const data = await response.json();
      tournaments = data.tournaments || [];
      renderTournaments(tournaments);
    } catch (err) {
      console.error("Error loading tournaments:", err);
    }
  }
  function renderTournaments(list) {
    grid.innerHTML = "";

    if (!list || list.length === 0) {
      emptyState.classList.remove("hidden");
      return;
    }

    emptyState.classList.add("hidden");

    list.forEach(t => {
      const poster = t.poster ? t.poster : "{% static 'images/empty.png' %}";
      const card = document.createElement("div");
      card.className = "bg-[#1b1b3a] rounded-2xl overflow-hidden shadow-lg hover:scale-105 transition transform duration-300";
      card.innerHTML = `
        <img src="${poster}" alt="${t.nama}" class="w-full h-52 object-cover">
        <div class="p-4">
          <h3 class="text-lg font-bold mb-1">${t.nama}</h3>
          <p class="text-sm text-gray-400 mb-1">${t.tipe} â€¢ ${t.lokasi}</p>
          <p class="text-sm text-gray-400 mb-2">ðŸ“… ${t.tanggal}</p>
          <p class="text-yellow-400 font-semibold mb-3">By ${t.pembuat}</p>
          <a href="/tournament/${t.id}/"
             class="inline-block mt-2 px-4 py-2 bg-yellow-400 text-black font-semibold rounded-lg hover:bg-yellow-500 transition">
            View Details
          </a>
        </div>
      `;
      grid.appendChild(card);
    });
  }
  searchInput.addEventListener("input", () => {
    const query = searchInput.value.toLowerCase();
    const filtered = tournaments.filter(t =>
      t.nama.toLowerCase().includes(query) ||
      t.lokasi.toLowerCase().includes(query) ||
      t.tipe.toLowerCase().includes(query)
    );
    renderTournaments(filtered);
  });
  allBtn.addEventListener("click", () => {
    allBtn.classList.add("bg-yellow-400", "text-black");
    myBtn?.classList.remove("bg-yellow-400", "text-black");
    renderTournaments(tournaments);
  });
  myBtn?.addEventListener("click", async () => {
    allBtn.classList.remove("bg-yellow-400", "text-black");
    myBtn.classList.add("bg-yellow-400", "text-black");

    try {
      const res = await fetch("/tournament/my/", {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      const data = await res.json();

      if (res.ok) {
        renderTournaments(data.tournaments || []);
      } else {
        alert(data.error || "Gagal memuat turnamenmu.");
      }
    } catch (err) {
      console.error("Error loading my tournaments:", err);
      alert("Gagal mengambil data turnamen kamu.");
    }
  });
  loadTournaments();
});
</script>

{% endblock content %}
