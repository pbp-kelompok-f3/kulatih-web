{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Find Your Tournament</title>
{% endblock meta %}

{% block content %}

<div class="bg-[#191831] min-h-screen text-white top-0 pb-10 font-bevietnam">
    <section data-aos="fade-down" class="relative text-white min-h-[400px] flex flex-col items-center justify-center overflow-hidden mb-12 px-6 text-center">
        <img 
            src="{% static 'image/bg-tournament.svg' %}" 
            alt="Tournament Background" 
            class="absolute inset-0 w-full h-full object-cover z-0"
        />
        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-[#0c0b1c]/60 to-[#191831] z-10"></div>
        <div class="relative z-20 space-y-4 max-w-3xl mx-auto py-16">
            <h1 class="heading-font font-bebas text-4xl sm:text-5xl md:text-6xl font-extrabold leading-tight text-white drop-shadow-lg">
                FIND YOUR <span class="text-[var(--yellow)]">PERFECT TOURNAMENT</span>
            </h1>
            <p class="max-w-2xl mx-auto text-gray-200 text-base sm:text-lg">
                Discover, join, and compete in tournaments that match your passion and skills.
            </p>
        </div>
    </section>



  <div class="max-w-7xl mx-auto px-6">
    <div data-aos="fade-up" class="flex justify-center gap-3 mt-6 mb-10">
      <button id="allBtn" class="px-5 py-2 bg-gray-700 rounded-full font-semibold hover:bg-yellow-400 hover:text-black transition">
        All Tournaments
      </button>
      {% if user.is_authenticated %}
      <button id="myBtn" class="px-5 py-2 bg-gray-700 rounded-full font-semibold hover:bg-yellow-400 hover:text-black transition">
        My Tournaments
      </button>
      {% endif %}
      {% if is_coach %}
      <a href="{% url 'tournaments:create_tournament' %}" class="px-5 py-2 bg-gray-700 rounded-full font-semibold hover:bg-yellow-400 hover:text-black transition">
        Create Tournament
      </a>
      {% endif %}
    </div>
    <div data-aos="fade-up" class="relative mb-10 flex justify-center">
      <input id="searchInput" type="text" placeholder="Find tournaments by name, location, organizer, or sport"
        class="w-full md:w-2/3 bg-[#1b1b3a] border border-gray-700 rounded-xl py-3 px-4 pl-12 text-gray-300 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400" />
      <svg xmlns="http://www.w3.org/2000/svg"
        class="hidden md:block w-5 h-5 absolute left-[calc(50%-33%)] top-1/2 -translate-y-1/2 text-gray-400"
        fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M21 21l-4.35-4.35M17 10a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    <div id="tournamentGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    <div id="emptyState" class="hidden text-center mt-10 text-gray-400">
      <p>No tournaments found.</p>
    </div>
    <div id="pagination" class="flex justify-center mt-10"></div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const grid = document.getElementById("tournamentGrid");
  const searchInput = document.getElementById("searchInput");
  const emptyState = document.getElementById("emptyState");
  const allBtn = document.getElementById("allBtn");
  const myBtn = document.getElementById("myBtn");
  const pagination = document.getElementById("pagination");
  let tournaments = [];
  let currentPage = 1;
  const itemsPerPage = 9;

  async function loadTournaments() {
    try {
      const response = await fetch(window.location.href, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      const data = await response.json();
      tournaments = data.tournaments || [];
      renderTournaments(tournaments);
    } catch (err) {
      console.error("Error loading tournaments:", err);
    }
  }

  function renderTournaments(list) {
    grid.innerHTML = "";
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageItems = list.slice(start, end);
    if (!pageItems || pageItems.length === 0) {
      emptyState.classList.remove("hidden");
      pagination.innerHTML = "";
      return;
    }
    emptyState.classList.add("hidden");
    pageItems.forEach(t => {
      const poster = t.poster ? t.poster : "{% static 'images/empty.png' %}";
      const card = document.createElement("div");
      card.className = "bg-[#1b1b3a] rounded-2xl overflow-hidden shadow-lg hover:scale-105 transition transform duration-300";
      card.innerHTML = `
        <div data-aos="fade-up" 
        class="relative group bg-gradient-to-br from-[#111024]/90 to-[#1c1a3a]/80 rounded-3xl border border-[#facc15]/20 overflow-hidden shadow-[0_0_20px_#facc15]/20 hover:shadow-[0_0_35px_#facc15]/40 transition-all duration-500 hover:-translate-y-2">

        <div class="relative h-56 overflow-hidden">
            <img src="${poster}" alt="${t.nama}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
            <div class="absolute inset-0 bg-gradient-to-t from-[#0f0e2e]/90 via-[#0f0e2e]/30 to-transparent"></div>
            <span class="absolute top-3 left-3 bg-yellow-400 text-black font-bold text-xs px-3 py-1 rounded-full shadow-md uppercase">${t.tipe}</span>
            <div class="absolute bottom-3 right-3 bg-[#facc15]/20 text-yellow-400 text-xs px-3 py-1 rounded-full border border-[#facc15]/30 backdrop-blur-sm font-semibold tracking-wide">
            ${t.tanggal}
            </div>
        </div>

        <div class="p-6 flex flex-col justify-between space-y-4">
            <div>
            <h3 class="text-2xl font-bold text-white tracking-tight group-hover:text-yellow-400 transition-colors">
                ${t.nama}
            </h3>
            <p class="text-gray-300 text-sm mt-2 flex items-center gap-2">
                <span>üèü</span> ${t.lokasi}
            </p>
            <p class="text-gray-400 text-sm mt-1 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="white" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 20.25a8.25 8.25 0 0115 0v.75H4.5v-.75z" />
            </svg>
            By ${t.pembuat}
            </p>
            </div>

            <a href="/tournament/${t.id}/"
            class="relative block text-center bg-yellow-400 text-black font-bold py-2 rounded-xl overflow-hidden transition-all duration-300 hover:bg-yellow-500 shadow-[0_0_15px_#facc15]/40">
            <span class="absolute inset-0 bg-gradient-to-r from-yellow-400 via-yellow-200 to-yellow-400 opacity-20 blur-md animate-pulse"></span>
            <span class="relative z-10">View Details</span>
            </a>
        </div>

        <div class="absolute inset-0 rounded-3xl border border-transparent group-hover:border-[#facc15]/50 transition-all duration-500"></div>
        </div>
      `;
      grid.appendChild(card);
    });
    renderPagination(list.length);
  }

  function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    pagination.innerHTML = "";
    if (totalPages <= 1) return;

    const maxVisible = 5;
    const prevBtn = document.createElement("button");
    prevBtn.textContent = "<";
    prevBtn.className = `mx-1 px-3 py-1 rounded-full ${currentPage === 1 ? "bg-gray-600 text-gray-400 cursor-not-allowed" : "bg-gray-700 text-white hover:bg-gray-600"}`;
    prevBtn.disabled = currentPage === 1;
    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTournaments(tournaments);
      }
    });
    pagination.appendChild(prevBtn);

    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);

    if (currentPage <= 3) {
      endPage = Math.min(totalPages, maxVisible);
    } else if (currentPage >= totalPages - 2) {
      startPage = Math.max(1, totalPages - maxVisible + 1);
    }

    if (startPage > 1) {
      addPageButton(1);
      if (startPage > 2) addEllipsis();
    }

    for (let i = startPage; i <= endPage; i++) {
      addPageButton(i);
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) addEllipsis();
      addPageButton(totalPages);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = ">";
    nextBtn.className = `mx-1 px-3 py-1 rounded-full ${currentPage === totalPages ? "bg-gray-600 text-gray-400 cursor-not-allowed" : "bg-gray-700 text-white hover:bg-gray-600"}`;
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderTournaments(tournaments);
      }
    });
    pagination.appendChild(nextBtn);

    function addPageButton(pageNum) {
      const btn = document.createElement("button");
      btn.textContent = pageNum;
      btn.className = `mx-1 px-3 py-1 rounded-full ${
        pageNum === currentPage
          ? "bg-yellow-400 text-black font-bold"
          : "bg-gray-700 text-white hover:bg-gray-600"
      }`;
      btn.addEventListener("click", () => {
        currentPage = pageNum;
        renderTournaments(tournaments);
      });
      pagination.appendChild(btn);
    }

    function addEllipsis() {
      const span = document.createElement("span");
      span.textContent = "...";
      span.className = "mx-2 text-gray-400";
      pagination.appendChild(span);
    }
  }

  searchInput.addEventListener("input", () => {
    currentPage = 1;
    const query = searchInput.value.toLowerCase();
    const filtered = tournaments.filter(t =>
      t.nama.toLowerCase().includes(query) ||
      t.lokasi.toLowerCase().includes(query) ||
      t.tipe.toLowerCase().includes(query) ||
      t.pembuat.toLowerCase().includes(query)
    );
    renderTournaments(filtered);
  });

  allBtn.addEventListener("click", () => {
    allBtn.classList.add("bg-yellow-400", "text-black");
    myBtn?.classList.remove("bg-yellow-400", "text-black");
    currentPage = 1;
    renderTournaments(tournaments);
  });

  myBtn?.addEventListener("click", async () => {
    allBtn.classList.remove("bg-yellow-400", "text-black");
    myBtn.classList.add("bg-yellow-400", "text-black");
    try {
      const res = await fetch("/tournament/my/", { headers: { "X-Requested-With": "XMLHttpRequest" } });
      const data = await res.json();
      if (res.ok) {
        currentPage = 1;
        renderTournaments(data.tournaments || []);
      } else {
        alert(data.error || "Gagal memuat turnamenmu.");
      }
    } catch (err) {
      console.error("Error loading my tournaments:", err);
      alert("Gagal mengambil data turnamen kamu.");
    }
  });

  loadTournaments();
});
</script>

{% endblock content %}
