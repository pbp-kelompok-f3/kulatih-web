<script>
document.addEventListener("DOMContentLoaded", function () {
  // ================== TABS ==================
  const btnUpcoming = document.getElementById("btn-upcoming");
  const btnHistory = document.getElementById("btn-history");
  const cards = document.querySelectorAll(".booking-card");

  const showCategory = cat => {
    cards.forEach(c => (c.style.display = c.dataset.category === cat ? "block" : "none"));
  };

  const setActiveTab = (active, inactive) => {
    active.classList.add("bg-[var(--yellow)]", "text-[var(--indigo-dark)]");
    active.classList.remove("bg-transparent", "text-[var(--white)]");
    inactive.classList.remove("bg-[var(--yellow)]", "text-[var(--indigo-dark)]");
    inactive.classList.add("bg-transparent", "text-[var(--white)]");
  };

  btnUpcoming?.addEventListener("click", () => {
    showCategory("upcoming");
    setActiveTab(btnUpcoming, btnHistory);
  });

  btnHistory?.addEventListener("click", () => {
    showCategory("history");
    setActiveTab(btnHistory, btnUpcoming);
  });

  showCategory("upcoming");
  setActiveTab(btnUpcoming, btnHistory);

  // ================== TOAST SYSTEM ==================
  const createToast = (message, type = "info") => {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.className = `
      fixed top-6 right-6 px-5 py-3 rounded-lg text-sm font-semibold z-[9999]
      ${type === "success" ? "bg-green-600 text-white" : ""}
      ${type === "error" ? "bg-[#b43d3d] text-white" : ""}
      ${type === "info" ? "bg-[var(--yellow)] text-[var(--indigo-dark)]" : ""}
      shadow-lg animate-fade-in-up transition-all duration-300
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.classList.add("opacity-0", "translate-y-2");
      setTimeout(() => toast.remove(), 400);
    }, 2500);
  };

  // ================== CANCEL BOOKING ==================
  document.querySelectorAll(".ajax-cancel-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      const url = btn.dataset.url;
      fetch(url, { method: "POST", headers: { "X-CSRFToken": getCookie("csrftoken") } })
        .then(r => {
          if (r.ok) createToast("Booking cancelled.", "error");
          setTimeout(() => location.reload(), 1000);
        });
    });
  });

  // ================== ACCEPT RESCHEDULE (COACH) ==================
  document.querySelectorAll(".ajax-accept-res-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      const url = btn.dataset.url;
      fetch(url, { method: "POST", headers: { "X-CSRFToken": getCookie("csrftoken") } })
        .then(r => {
          if (r.ok) createToast("Reschedule accepted!", "success");
          setTimeout(() => location.reload(), 1000);
        });
    });
  });

  // ================== REJECT RESCHEDULE (COACH) ==================
  document.querySelectorAll(".ajax-reject-res-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      const url = btn.dataset.url;
      fetch(url, { method: "POST", headers: { "X-CSRFToken": getCookie("csrftoken") } })
        .then(r => {
          if (r.ok) createToast("Reschedule rejected.", "error");
          setTimeout(() => location.reload(), 1000);
        });
    });
  });

  // ================== CONFIRM BOOKING (COACH) ==================
  document.querySelectorAll(".ajax-confirm-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      const url = btn.dataset.url;
      fetch(url, { method: "POST", headers: { "X-CSRFToken": getCookie("csrftoken") } })
        .then(r => {
          if (r.ok) createToast("Booking confirmed!", "success");
          setTimeout(() => location.reload(), 1000);
        });
    });
  });

  // ================== RESCHEDULE MODAL (MEMBER) ==================
  const modal = document.getElementById("reschedule-modal");
  if (modal) {
    const closeModal = document.getElementById("close-modal");
    const saveReschedule = document.getElementById("save-reschedule");
    const dateInput = document.getElementById("reschedule-date");
    let currentBookingId = null;

    document.querySelectorAll(".open-reschedule").forEach(btn => {
      btn.addEventListener("click", () => {
        currentBookingId = btn.dataset.bookingId;
        modal.classList.remove("hidden");
      });
    });

    closeModal?.addEventListener("click", () => modal.classList.add("hidden"));

    saveReschedule?.addEventListener("click", () => {
      const newDate = dateInput.value;
      if (!newDate) return createToast("Please select a date & time.", "error");

      fetch(`/booking/ajax_reschedule/${currentBookingId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ date: newDate }),
      })
        .then(r => {
          if (r.ok) {
            modal.classList.add("hidden");
            createToast("Reschedule request sent!", "info");
            setTimeout(() => location.reload(), 1000);
          } else {
            createToast("Failed to reschedule.", "error");
          }
        })
        .catch(() => createToast("Server error.", "error"));
    });
  }

  // ================== CSRF HELPER ==================
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

<style>
@keyframes fade-in-up {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in-up {
  animation: fade-in-up 0.4s ease-out;
}
</style>
