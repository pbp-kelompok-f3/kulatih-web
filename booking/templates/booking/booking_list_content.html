{% load static %}

<div class="min-h-screen bg-[var(--indigo)] px-6 py-10 text-[var(--white)]">
  <div class="max-w-4xl mx-auto">

    <!-- Header Section -->
    <div class="mb-10 text-left">
      <h1 class="heading-font text-[var(--yellow)] text-5xl mb-4">MY BOOKINGS</h1>
      <button
        class="heading-font text-base px-10 py-2 bg-[var(--white)] text-[var(--indigo-dark)] font-bold rounded-md shadow-sm">
        DETAILS
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex justify-center mb-10">
      <div
        class="flex w-full max-w-4xl bg-[var(--indigo)] border border-[rgba(255,255,255,0.2)] rounded-xl p-2 gap-3 shadow-[0_0_20px_rgba(0,0,0,0.25)]">

        <!-- Upcoming -->
        <button id="btn-upcoming"
          class="flex-1 py-3 font-semibold text-sm rounded-md transition-all
                 bg-[var(--yellow)] text-[var(--indigo-dark)]
                 border border-[rgba(255,255,255,0.2)]
                 hover:brightness-105">
          Upcoming
        </button>

        <!-- Booking History -->
        <button id="btn-history"
          class="flex-1 py-3 font-semibold text-sm rounded-md transition-all
                 bg-transparent text-[var(--white)]
                 border border-[rgba(255,255,255,0.2)]
                 hover:brightness-125">
          Booking History
        </button>
      </div>
    </div>

    <!-- Booking List -->
    {% if bookings %}
      <div id="bookings-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for b in bookings %}
        <article
          class="booking-card rounded-2xl bg-[var(--indigo-light)] border border-[var(--indigo-light)] p-6 shadow-[0_8px_24px_rgba(0,0,0,.3)] relative"
          data-category="{% if b.status == 'cancelled' or b.status == 'completed' or b.date < today %}history{% else %}upcoming{% endif %}">

          <!-- Header Info -->
          <div class="flex items-start justify-between mb-3 border-b border-[rgba(255,255,255,0.15)] pb-2">
            <div class="flex items-start gap-2 text-[13px] text-[rgba(255,255,255,0.85)]">
              <i class="fa-regular fa-calendar text-[var(--white)] opacity-80 mt-[2px]"></i>
              <div class="flex flex-col">
                <span>{{ b.date|date:"l, d F Y" }}</span>
                <span class="text-[12px] text-[rgba(255,255,255,0.6)] mt-[2px]">
                  {{ b.start_time|time:"H:i" }}–{{ b.end_time|time:"H:i" }} WIB
                </span>
              </div>
            </div>

            <!-- Status Badge -->
            <span class="heading-font px-3 py-[2px] rounded-md text-[10px] font-bold uppercase tracking-[1px]
              {% if b.status == 'confirmed' %} bg-green-700 text-white
              {% elif b.status == 'pending' %} bg-[var(--yellow)] text-[var(--indigo-dark)]
              {% elif b.status == 'rescheduled' %} bg-purple-600 text-white
              {% elif b.status == 'completed' %} bg-[var(--gray)] text-[var(--white)]
              {% else %} bg-gray-600 text-white {% endif %}">
              {{ b.get_status_display }}
            </span>
          </div>

          <!-- Coach Section -->
          <div class="flex items-center gap-4 mb-4">
            <img src="{% static 'images/default-coach.png' %}" alt="coach photo"
                class="w-16 h-16 rounded-full object-cover border border-[rgba(255,255,255,0.2)]">
            <div>
              <div class="heading-font text-xl leading-tight">
                {% for c in b.coach.all %}{{ c.name }}{% if not forloop.last %}, {% endif %}{% empty %}Coach{% endfor %}
              </div>
              <div class="text-sm text-[var(--gray)]">
                {% for c in b.coach.all %}{{ c.sport }}{% if not forloop.last %}, {% endif %}{% endfor %}
              </div>
            </div>
          </div>

          <!-- Location -->
          <div class="flex items-center gap-2 text-sm text-[var(--gray)] mb-6">
            <i class="fa-solid fa-location-dot"></i>
            <span>{% if b.coach.first %}{{ b.coach.first.location|default:"Location not set" }}{% else %}No location{% endif %}</span>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-2">
            {% if b.status not in 'cancelled completed' %}
              <button class="cancel-btn heading-font px-4 py-1.5 rounded-md bg-red-600 text-white text-sm"
                      data-cancel-url="{% url 'booking:ajax_cancel' b.id %}">Cancel</button>
              <a class="heading-font px-4 py-1.5 rounded-md bg-[var(--yellow)] text-[var(--indigo-dark)] text-sm cursor-pointer">View Details</a>
              <button class="res-btn heading-font px-4 py-1.5 rounded-md bg-[var(--indigo-dark)] text-[var(--white)] text-sm"
                      data-res-id="{{ b.id }}">Reschedule</button>

            {% elif b.status == 'completed' %}
              <!-- >>>> Leave Review trigger (tidak menyentuh backend booking) -->
              <a class="heading-font px-4 py-1.5 rounded-md bg-[var(--yellow)] text-[var(--indigo-dark)] text-sm cursor-pointer"
                 href="#"
                 data-review-open="{{ b.coach.first.id }}">Leave Review</a>
              <a class="heading-font px-4 py-1.5 rounded-md bg-[var(--indigo-dark)] text-[var(--white)] text-sm cursor-pointer">Book Again</a>

            {% elif b.status == 'cancelled' %}
              <span class="heading-font px-4 py-1.5 rounded-md bg-gray-600 text-white text-sm cursor-default">Cancelled</span>
            {% endif %}
          </div>

          <!-- Hidden Reschedule Form -->
          <form class="res-form hidden mt-4" data-res-form="{{ b.id }}">
            {% csrf_token %}
            <div class="grid grid-cols-3 gap-2">
              <input type="date" name="new_date" value="{{ b.date|date:'Y-m-d' }}"
                    class="rounded-md px-2 py-2 text-sm bg-[var(--indigo-dark)] border border-[var(--indigo-dark)] text-[var(--white)]" required>
              <input type="time" name="new_start_time" value="{{ b.start_time|time:'H:i' }}"
                    class="rounded-md px-2 py-2 text-sm bg-[var(--indigo-dark)] border border-[var(--indigo-dark)] text-[var(--white)]" required>
              <input type="time" name="new_end_time" value="{{ b.end_time|time:'H:i' }}"
                    class="rounded-md px-2 py-2 text-sm bg-[var(--indigo-dark)] border border-[var(--indigo-dark)] text-[var(--white)]" required>
            </div>
            <div class="mt-3 flex gap-2">
              <button type="button" class="save-res-btn heading-font px-4 py-2 rounded-md bg-[var(--yellow)] text-[var(--indigo-dark)] text-sm"
                      data-res-save="{{ b.id }}" data-url="{% url 'booking:ajax_reschedule' b.id %}">Save</button>
              <button type="button" class="cancel-res-btn heading-font px-4 py-2 rounded-md bg-[var(--indigo-dark)] text-[var(--white)] text-sm"
                      data-res-cancel="{{ b.id }}">Cancel</button>
            </div>
          </form>

          {% if b.coach.first %}
            {% with coach_id=b.coach.first.id coach_username=b.coach.first.user.username %}
              <!-- Modal -->
              <div id="rfm-{{ coach_id }}" class="fixed inset-0 hidden items-center justify-center z-[100]"
                   style="background:rgba(0,0,0,.6);">
                <div class="w-[92vw] max-w-[680px] rounded-2xl border p-6"
                     style="background:var(--indigo); border-color:#2e2b55; color:var(--white);">
                  <div class="mb-4">
                    <div class="heading-font text-[22px] md:text-[26px]">RATE YOUR COACH</div>
                    <div class="font-bevietnam opacity-75 text-sm">
                      Your honest feedback is valuable to us {{ coach_username|default:"" }}.
                    </div>
                  </div>

                  <div class="mb-3">
                    <div class="font-bevietnam text-sm opacity-80 mb-1">YOUR RATING</div>
                    <div class="flex gap-2 text-3xl select-none">
                      {% for n in "12345" %}
                        <button type="button" class="rfm-star-{{ coach_id }} cursor-pointer"
                                aria-label="{{ forloop.counter }} star"
                                data-val="{{ forloop.counter }}" style="color:#3c395f;">★</button>
                      {% endfor %}
                    </div>
                  </div>

                  <div class="mb-5">
                    <div class="font-bevietnam text-sm opacity-80 mb-1">FEEDBACK (optional)</div>
                    <textarea id="rfm-comment-{{ coach_id }}" rows="6"
                              class="w-full rounded-lg p-3 outline-none"
                              style="background:var(--indigo-light); color:var(--white); border:1px solid #2e2b55;"
                              placeholder="Share your experience…"></textarea>
                  </div>

                  <div class="flex justify-end gap-3">
                    <button type="button" data-review-cancel="{{ coach_id }}"
                            class="px-4 py-2 rounded-lg font-bevietnam text-sm"
                            style="background:#be3a3a; color:#fff;">CANCEL</button>
                    <button type="button" data-review-submit="{{ coach_id }}"
                            class="px-5 py-2 rounded-lg font-bevietnam text-sm"
                            style="background:var(--yellow); color:#1a1834;">SUBMIT</button>
                  </div>
                </div>
              </div>

              <!-- Script modal (isolated per coach_id) -->
              <script>
              (function(){
                const coachId   = "{{ coach_id }}";
                const modal     = document.getElementById("rfm-" + coachId);
                const commentEl = document.getElementById("rfm-comment-" + coachId);
                const stars     = modal.querySelectorAll(".rfm-star-{{ coach_id }}");
                const CREATE_URL = "{% url 'reviews:create_review_json' '00000000-0000-0000-0000-000000000000' %}"
                                   .replace('00000000-0000-0000-0000-000000000000', coachId);
                let rating = 0;

                function getCookie(name){
                  const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m ? m.pop() : '';
                }
                function paint(n){ stars.forEach((s,i)=>{ s.style.color = (i<n) ? "var(--yellow)" : "#3c395f"; }); }

                stars.forEach(btn=>{
                  btn.addEventListener('mouseenter', ()=>paint(+btn.dataset.val));
                  btn.addEventListener('mouseleave', ()=>paint(rating));
                  btn.addEventListener('click',     ()=>{ rating = +btn.dataset.val; paint(rating); });
                });

                function openModal(triggerBtn){
                  rating = 0; paint(0); commentEl.value = "";
                  modal.classList.remove("hidden"); modal.classList.add("flex");
                  modal._triggerBtn = triggerBtn || null;
                }
                function closeModal(){ modal.classList.add("hidden"); modal.classList.remove("flex"); }

                // trigger: tombol Leave Review yang match coachId
                document.addEventListener("click", function(e){
                  const btn = e.target.closest('[data-review-open="{{ coach_id }}"]');
                  if (btn){ e.preventDefault(); openModal(btn); }
                });

                modal.querySelector('[data-review-cancel="{{ coach_id }}"]').onclick = closeModal;

                modal.querySelector('[data-review-submit="{{ coach_id }}"]').onclick = async function(){
                  if (!rating){ alert("Please select a rating (1–5)."); return; }
                  const payload = { rating: rating, comment: commentEl.value || "" };

                  const res = await fetch(CREATE_URL, {
                    method: "POST",
                    headers: { "Content-Type":"application/json", "X-CSRFToken": getCookie("csrftoken") },
                    body: JSON.stringify(payload),
                  });
                  const data = await res.json().catch(()=> ({}));
                  if (!res.ok){ alert(data.error || "Failed to submit review."); return; }

                  // ubah tombol pemicu jadi "View your review"
                  const t = modal._triggerBtn;
                  if (t){
                    const detailUrl = "{% url 'reviews:review_detail_page' 0 %}".replace('/0/', '/' + data.id + '/');
                    t.textContent = "View your review";
                    t.setAttribute("href", detailUrl);
                    t.setAttribute("data-review-open", ""); // matikan open modal
                    t.onclick = null;
                  }
                  closeModal();
                };

                modal.addEventListener("click", (e)=>{ if (e.target === modal) closeModal(); });
              })();
              </script>
            {% endwith %}
          {% endif %}
          {# ==================== END REVIEW MODAL ==================== #}

        </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="rounded-2xl p-16 text-center bg-[var(--indigo-light)] border border-[var(--indigo-light)] shadow-[0_12px_40px_rgba(0,0,0,.35)]">
        <h2 class="heading-font text-3xl mb-2">NO BOOKINGS</h2>
        <p class="opacity-70">You don’t have any bookings yet.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- JS booking (punya temanmu) -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const btnUpcoming = document.getElementById('btn-upcoming');
    const btnHistory = document.getElementById('btn-history');
    const cards = document.querySelectorAll('.booking-card');

    function showCategory(category) {
      cards.forEach(card => {
        card.style.display = (card.dataset.category === category) ? 'block' : 'none';
      });
    }

    function setActiveTab(tab) {
      if (tab === 'upcoming') {
        btnUpcoming.classList.add('bg-[var(--yellow)]', 'text-[var(--indigo-dark)]');
        btnUpcoming.classList.remove('bg-transparent', 'text-[var(--white)]');
        btnHistory.classList.add('bg-transparent', 'text-[var(--white)]');
        btnHistory.classList.remove('bg-[var(--yellow)]', 'text-[var(--indigo-dark)]');
      } else {
        btnHistory.classList.add('bg-[var(--yellow)]', 'text-[var(--indigo-dark)]');
        btnHistory.classList.remove('bg-transparent', 'text-[var(--white)]');
        btnUpcoming.classList.add('bg-transparent', 'text-[var(--white)]');
        btnUpcoming.classList.remove('bg-[var(--yellow)]', 'text-[var(--indigo-dark)]');
      }
      [btnUpcoming, btnHistory].forEach(btn => {
        btn.classList.add('border', 'border-[rgba(255,255,255,0.2)]');
      });
    }

    btnUpcoming.addEventListener('click', () => { showCategory('upcoming'); setActiveTab('upcoming'); });
    btnHistory.addEventListener('click', () => { showCategory('history'); setActiveTab('history'); });

    showCategory('upcoming');
    setActiveTab('upcoming');

    // AJAX CANCEL
    document.querySelectorAll('.cancel-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!confirm('Are you sure you want to cancel this booking?')) return;
        fetch(btn.dataset.cancelUrl, {
          method: 'POST',
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            alert('Booking cancelled!');
            btn.closest('.booking-card').querySelector('.heading-font.text-sm').innerText = 'Cancelled';
            btn.closest('.booking-card').style.opacity = '0.7';
            btn.closest('.booking-card').dataset.category = 'history';
          } else alert('Failed: ' + data.error);
        })
        .catch(() => alert('Error cancelling booking.'));
      });
    });

    // SHOW RESCHEDULE FORM
    document.querySelectorAll('.res-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const form = document.querySelector(`[data-res-form="${btn.dataset.resId}"]`);
        form.classList.toggle('hidden');
      });
    });

    // AJAX RESCHEDULE SAVE
    document.querySelectorAll('.save-res-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const form = document.querySelector(`[data-res-form="${btn.dataset.resSave}"]`);
        const formData = new FormData(form);
        fetch(btn.dataset.url, {
          method: 'POST',
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok) { alert('Booking rescheduled successfully!'); location.reload(); }
          else alert('Failed: ' + data.error);
        })
        .catch(() => alert('Error saving reschedule.'));
      });
    });

    // CANCEL RESCHEDULE FORM
    document.querySelectorAll('.cancel-res-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const form = document.querySelector(`[data-res-form="${btn.dataset.resCancel}"]`);
        form.classList.add('hidden');
      });
    });
  });
</script>

<!-- Auto-switch ke "View your review" saat halaman dibuka -->
<script>
document.addEventListener('DOMContentLoaded', async function () {
  const btns = document.querySelectorAll('[data-review-open]');
  for (const btn of btns) {
    const coachId = btn.getAttribute('data-review-open');
    try {
      const url = new URL(`/reviews/coach/${coachId}/`, window.location.origin);
      url.searchParams.set('page', 1);
      url.searchParams.set('page_size', 20);
      const res = await fetch(url);
      if (!res.ok) continue;
      const data = await res.json();
      const mine = (data.items || []).find(it => it.is_owner);
      if (mine) {
        btn.textContent = 'View your review';
        btn.href = "{% url 'reviews:review_detail_page' 0 %}".replace('/0/', '/' + mine.id + '/');
        btn.removeAttribute('data-review-open'); // supaya tidak buka modal lagi
      }
    } catch (e) {}
  }
});
</script>
