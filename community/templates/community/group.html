{% extends "base.html" %}
{% load static %}
{% block title %}Community Group{% endblock %}
{% block content %}

<section class="min-h-screen bg-[var(--indigo)] text-[var(--white)] px-8 md:px-20 py-12 font-bevietnam flex flex-col">
  <h1 class="text-center text-5xl md:text-6xl font-bebas tracking-wide mb-10">
    {{ community.name|upper }}
  </h1>

  <!-- Chat Box Wrapper (background slightly lighter indigo) -->
  <div class="flex-1 bg-[var(--indigo-light)] rounded-2xl p-8 shadow-lg overflow-y-auto">
    <div id="messages" class="flex flex-col gap-6">
      {% for msg in messages %}
        {% if msg.sender_id == user.id %}
          <!-- Pesan sendiri -->
          <div class="flex flex-col items-end message-container" data-id="{{ msg.id }}">
            <div class="text-xs text-[var(--white)] mb-1">{{ msg.sender.username }}</div>
            <div class="relative bg-[var(--yellow)] text-[var(--indigo-dark)] px-5 py-3 rounded-2xl max-w-[70%] text-right font-medium">
              {{ msg.text }}
            </div>
            <div class="flex justify-end gap-3 text-xs text-gray-400 mt-1">
              <a href="{% url 'community:edit_message' community.id msg.id %}" class="hover:underline">edit</a>
              <a href="#" class="delete-btn hover:underline" data-id="{{ msg.id }}">delete</a>
            </div>
          </div>
        {% else %}
          <!-- Pesan orang lain -->
          <div class="flex flex-col items-start message-container" data-id="{{ msg.id }}">
            <div class="text-xs text-[var(--white)] mb-1">{{ msg.sender.username }}</div>
            <div class="bg-[var(--white)] text-[var(--indigo-dark)] px-5 py-3 rounded-2xl max-w-[70%] font-medium">
              {{ msg.text }}
            </div>
          </div>
        {% endif %}
      {% empty %}
        <p class="text-center text-gray-400 italic">no messages yet, be the first to say hi!</p>
      {% endfor %}
    </div>
  </div>

  <!-- Form Kirim Pesan -->
  <form id="message-form" class="flex items-center justify-center gap-4 mt-6">
    {% csrf_token %}
    <input id="message-input" type="text" name="text" placeholder="Type your message..."
           class="flex-1 rounded-xl px-4 py-3 text-[var(--indigo-dark)] outline-none">
    <button type="submit"
            class="bg-[var(--yellow)] text-[var(--indigo-dark)] font-bebas text-xl px-8 py-3 rounded-2xl shadow-md hover:scale-105 transition-transform">
      SEND
    </button>
  </form>
</section>

<!-- AJAX Script -->
<script>
document.querySelector('#message-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const text = document.querySelector('#message-input').value.trim();
  if (!text) return;

  const response = await fetch("{% url 'community:send_message_ajax' community.id %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ text })
  });

  const data = await response.json();
  if (data.text) {
    const chatBox = document.querySelector('#messages');
    chatBox.innerHTML += `
      <div class="flex flex-col items-end message-container" data-id="${data.id}">
        <div class="text-xs text-[var(--white)] mb-1">${data.sender}</div>
        <div class="relative bg-[var(--yellow)] text-[var(--indigo-dark)] px-5 py-3 rounded-2xl max-w-[70%] text-right font-medium">
          ${data.text}
        </div>
        <div class="flex justify-end gap-3 text-xs text-gray-400 mt-1">
          <a href="/community/my/${data.community_id}/message/${data.id}/edit/" class="hover:underline">edit</a>
          <a href="#" class="delete-btn hover:underline" data-id="${data.id}">delete</a>
        </div>
      </div>
    `;
    document.querySelector('#message-input').value = '';
    chatBox.scrollTop = chatBox.scrollHeight;
  }
});

// DELETE Message via AJAX
document.addEventListener('click', async e => {
  if (e.target.classList.contains('delete-btn')) {
    e.preventDefault();
    const msgId = e.target.dataset.id;
    const msgContainer = e.target.closest('.message-container');
    const response = await fetch(`/community/my/{{ community.id }}/message/${msgId}/delete/`, {
      method: 'DELETE',
      headers: {'X-CSRFToken': '{{ csrf_token }}'},
    });
    const data = await response.json();
    if (data.success) msgContainer.remove();
  }
});
</script>

{% endblock %}
