
<div id="rfm-{{ coach_id }}" class="fixed inset-0 hidden items-center justify-center z-[100]"
     style="background:rgba(0,0,0,.6);">
  <div class="w-[92vw] max-w-[680px] rounded-2xl border p-6"
       style="background:var(--indigo); border-color:#2e2b55; color:var(--white);">
      <div class="mb-4 text-center">
        <div class="heading-font text-[22px] md:text-[26px]">RATE YOUR COACH</div>
      <div class="font-bevietnam opacity-75 text-sm">
        Your honest feedback is valuable to us.
      </div>
    </div>

    <!-- Stars -->
    <div class="mb-3">
      <div class="font-bevietnam text-sm opacity-80 mb-1">YOUR RATING</div>
      <div class="flex gap-2 text-3xl select-none">
        {% for n in "12345" %}
          <button type="button" class="rfm-star-{{ coach_id }} cursor-pointer"
                  aria-label="{{ forloop.counter }} star"
                  data-val="{{ forloop.counter }}" style="color:#3c395f;">★</button>
        {% endfor %}
      </div>
    </div>

    <!-- Feedback -->
    <div class="mb-5">
      <div class="font-bevietnam text-sm opacity-80 mb-1">FEEDBACK (optional)</div>
      <textarea id="rfm-comment-{{ coach_id }}" rows="6"
                class="w-full rounded-lg p-3 outline-none"
                style="background:var(--indigo-light); color:var(--white); border:1px solid #2e2b55;"
                placeholder="Share your experience…"></textarea>
    </div>

    <div class="flex justify-end gap-3">
      <button type="button" data-review-cancel="{{ coach_id }}"
              class="px-4 py-2 rounded-lg font-bevietnam text-sm"
              style="background:#be3a3a; color:#fff;">CANCEL</button>
      <button type="button" data-review-submit="{{ coach_id }}"
              class="px-5 py-2 rounded-lg font-bevietnam text-sm"
              style="background:var(--yellow); color:#1a1834;">SUBMIT</button>
    </div>
  </div>
</div>

<script>
(function(){
  const coachId   = "{{ coach_id }}";
  const modal     = document.getElementById("rfm-" + coachId);
  const commentEl = document.getElementById("rfm-comment-" + coachId);
  const stars     = modal.querySelectorAll(".rfm-star-{{ coach_id }}");

  const CREATE_URL = "{% url 'reviews:create_review_json' '00000000-0000-0000-0000-000000000000' %}"
                     .replace('00000000-0000-0000-0000-000000000000', coachId);

  let rating = 0;

  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  function paint(n){ stars.forEach((s,i)=>{ s.style.color = (i<n) ? "var(--yellow)" : "#3c395f"; }); }

  stars.forEach(btn=>{
    btn.addEventListener('mouseenter', ()=>paint(+btn.dataset.val));
    btn.addEventListener('mouseleave', ()=>paint(rating));
    btn.addEventListener('click',     ()=>{ rating = +btn.dataset.val; paint(rating); });
  });

  function openModal(triggerBtn){
    rating = 0; paint(0); commentEl.value = "";
    modal.classList.remove("hidden"); modal.classList.add("flex");
    modal._triggerBtn = triggerBtn || null;
  }
  function closeModal(){ modal.classList.add("hidden"); modal.classList.remove("flex"); }

  // tombol di Booking History
  document.addEventListener("click", function(e){
    const btn = e.target.closest('[data-review-open="{{ coach_id }}"]');
    if (btn){ e.preventDefault(); openModal(btn); }
  });

  modal.querySelector('[data-review-cancel="{{ coach_id }}"]').onclick = closeModal;

  modal.querySelector('[data-review-submit="{{ coach_id }}"]').onclick = async function(){
    if (!rating){ alert("Please select a rating (1–5)."); return; }
    const payload = { rating: rating, comment: commentEl.value || "" };

    const res = await fetch(CREATE_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json", "X-CSRFToken": getCookie("csrftoken") },
      body: JSON.stringify(payload),
    });
    const data = await res.json().catch(()=> ({}));

    if (!res.ok){ alert(data.error || "Failed to submit review."); return; }

    // "View your review" -> ke Review Detail
    const t = modal._triggerBtn;
    if (t){
      const detailUrl = "{% url 'reviews:review_detail_page' 0 %}".replace('/0/', '/' + data.id + '/');
      t.textContent = "View your review";
      t.setAttribute("href", detailUrl);
      t.setAttribute("data-review-open", ""); // matikan open modal
      t.onclick = null;
    }

    closeModal();
  };

  modal.addEventListener("click", (e)=>{ if (e.target === modal) closeModal(); });
})();
</script>
