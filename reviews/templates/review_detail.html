{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="min-h-screen px-6 py-10 flex justify-center" style="background:var(--indigo-dark); color:var(--white);">
  <div class="w-full max-w-4xl">

    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <h2 class="heading-font text-[28px] md:text-[32px]" style="color:var(--yellow);">
        RATING AND FEEDBACK
      </h2>
      <a href="{% url 'users:coach_detail' review.coach_id %}"
         class="text-sm underline opacity-80">← Back to coach</a>
    </div>

    <!-- Card -->
    <article class="rounded-2xl border px-5 py-4" style="background:var(--indigo-light); border-color:#2e2b55;">
      <div class="flex gap-4">
        <!-- Avatar initial -->
        <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background:#2f2c56;">
          <span class="heading-font text-xl">
            {{ reviewer_username|default:"?"|slice:":1"|upper }}
          </span>
        </div>

        <div class="flex-1">
          <div class="flex items-start justify-between">
            <div>
              <div class="font-bevietnam font-semibold">@{{ reviewer_username }}</div>

              <!-- rating wrapper -> akan diupdate live setelah edit -->
              <div class="font-bevietnam opacity-90 text-sm" data-review-rating-wrap>
                {{ review.rating }}
                <span style="color:var(--yellow);">
                  {% for _ in ""|center:review.rating %}★{% endfor %}
                </span>
                <span style="color:#3c395f;">
                  {% for _ in ""|center:5-review.rating %}★{% endfor %}
                </span>
              </div>
            </div>

            {% if is_owner %}
            <div class="flex gap-2">
              <button id="btn-edit"
                      class="px-4 py-2 rounded-lg font-bevietnam text-sm"
                      style="background:#ffd666; color:#28253e;">
                EDIT
              </button>
              <button id="btn-delete"
                      class="px-4 py-2 rounded-lg font-bevietnam text-sm"
                      style="background:#e24b4b; color:white;">
                DELETE
              </button>
            </div>
            {% endif %}
          </div>

          <!-- comment wrapper -> juga diupdate live -->
          <p class="font-bevietnam mt-3 opacity-90" data-review-comment>{{ review.comment }}</p>
        </div>
      </div>
    </article>

  </div>
</div>

{% if is_owner %}
<!-- ===== Edit Modal (prefilled) ===== -->
<div id="rfe-modal" class="fixed inset-0 hidden items-center justify-center z-[100]"
     style="background:rgba(0,0,0,.6);">
  <div class="w-[92vw] max-w-[680px] rounded-2xl border p-6"
       style="background:var(--indigo); border-color:#2e2b55; color:var(--white);">
    <div class="mb-4">
      <div class="heading-font text-[22px] md:text-[26px]">RATE YOUR COACH</div>
      <div class="font-bevietnam opacity-75 text-sm">You can update your rating & feedback.</div>
    </div>

    <!-- Stars (punya cursor-pointer) -->
    <div class="mb-3">
      <div class="font-bevietnam text-sm opacity-80 mb-1">YOUR RATING</div>
      <div class="flex gap-2 text-3xl select-none">
        <button type="button" class="rfe-star cursor-pointer" aria-label="1 star" data-val="1" style="color:#3c395f;">★</button>
        <button type="button" class="rfe-star cursor-pointer" aria-label="2 stars" data-val="2" style="color:#3c395f;">★</button>
        <button type="button" class="rfe-star cursor-pointer" aria-label="3 stars" data-val="3" style="color:#3c395f;">★</button>
        <button type="button" class="rfe-star cursor-pointer" aria-label="4 stars" data-val="4" style="color:#3c395f;">★</button>
        <button type="button" class="rfe-star cursor-pointer" aria-label="5 stars" data-val="5" style="color:#3c395f;">★</button>
      </div>
    </div>

    <!-- Feedback -->
    <div class="mb-5">
      <div class="font-bevietnam text-sm opacity-80 mb-1">FEEDBACK (optional)</div>
      <textarea id="rfe-comment" rows="6"
                class="w-full rounded-lg p-3 outline-none"
                style="background:var(--indigo-light); color:var(--white); border:1px solid #2e2b55;"
                placeholder="Share your experience…"></textarea>
    </div>

    <div class="flex justify-end gap-3">
      <button type="button" id="rfe-cancel"
              class="px-4 py-2 rounded-lg font-bevietnam text-sm"
              style="background:#be3a3a; color:#fff;">CANCEL</button>
      <button type="button" id="rfe-submit"
              class="px-5 py-2 rounded-lg font-bevietnam text-sm"
              style="background:var(--yellow); color:#1a1834;">SUBMIT</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ---------- helpers ----------
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  function paintStars(n){
    stars.forEach((s, i)=>{ s.style.color = (i < n) ? "var(--yellow)" : "#3c395f"; });
  }

  // ---------- DOM ----------
  const btnEdit    = document.getElementById('btn-edit');
  const btnDel     = document.getElementById('btn-delete');
  const ratingWrap = document.querySelector('[data-review-rating-wrap]');
  const commentP   = document.querySelector('[data-review-comment]');

  const modal     = document.getElementById('rfe-modal');
  const stars     = modal.querySelectorAll('.rfe-star');
  const commentEl = document.getElementById('rfe-comment');

  // nilai awal dari server
  const initialRating = Number('{{ review.rating|default:0 }}') || 0;
  let rating = initialRating;

  // ---------- modal open/close ----------
  function openModal(){
    commentEl.value = '{{ review.comment|escapejs }}';  // prefill comment
    paintStars(rating);                                 // prefill stars
    modal.classList.remove('hidden'); modal.classList.add('flex');
  }
  function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }

  // bintang interaktif
  stars.forEach(btn=>{
    btn.addEventListener('mouseenter', ()=>paintStars(+btn.dataset.val));
    btn.addEventListener('mouseleave', ()=>paintStars(rating));
    btn.addEventListener('click',     ()=>{ rating = +btn.dataset.val; paintStars(rating); });
  });

  // hook tombol
  btnEdit && (btnEdit.onclick = openModal);
  document.getElementById('rfe-cancel').onclick = closeModal;
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

  // ---------- submit update (AJAX) ----------
  document.getElementById('rfe-submit').onclick = async function(){
    if (!rating){ alert("Please select a rating (1–5)."); return; }
    const url = "{% url 'reviews:update_review_json' review.id %}";
    const payload = { rating: rating, comment: commentEl.value || "" };

    const res = await fetch(url, {
      method: "POST", // server kamu menerima PATCH/PUT/POST
      headers: { "Content-Type":"application/json", "X-CSRFToken": getCookie("csrftoken") },
      body: JSON.stringify(payload),
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok){ alert(data.error || "Failed to update."); return; }

    // update tampilan rating & comment di halaman ini
    if (ratingWrap){
      const filled = '★'.repeat(data.rating);
      const empty  = '★'.repeat(5 - data.rating);
      ratingWrap.innerHTML = `${data.rating} <span style="color:var(--yellow)">${filled}</span><span style="color:#3c395f">${empty}</span>`;
    }
    if (commentP){ commentP.textContent = data.comment || ''; }

    closeModal();
  };

  // ---------- delete ----------
  btnDel && (btnDel.onclick = async function(){
    if (!confirm('Delete this review?')) return;
    const url = "{% url 'reviews:delete_review_json' review.id %}";
    const res = await fetch(url, { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')} });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok){ alert(data.error || 'Failed to delete.'); return; }
    // balik ke coach detail
    window.location.href = "{% url 'users:coach_detail' review.coach_id %}";
  });
})();
</script>
{% endif %}
{% endblock %}
