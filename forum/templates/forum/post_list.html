{% extends "base.html" %}
{% block title %}Forum | KuLatih{% endblock %}
{% block content %}

<div class="min-h-[80vh] bg-[#191831] text-[#F5F5F5]">
  <div class="max-w-4xl mx-auto px-4 py-10 space-y-6">

    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="heading-font text-4xl leading-none text-[#D3B53E]">FORUM</h1>
        <span class="heading-font inline-block mt-2 text-base px-3 py-1 rounded tracking-wide bg-[#191831] border border-[#2A2947]">
          SHARE YOUR THOUGHTS
        </span>
      </div>

      {% if request.user.is_authenticated %}
        <button id="openModal" class="heading-font px-5 py-2 rounded-md bg-[#D3B53E] text-[#111024] shadow hover:brightness-110 transition">
          ADD
        </button>
      {% else %}
        <a href="{% url 'login' %}" class="heading-font px-5 py-2 rounded-md bg-[#D3B53E] text-[#111024] shadow hover:brightness-110 transition">
          LOGIN TO POST
        </a>
      {% endif %}
    </div>

    {% if not posts %}
      <div class="rounded-2xl bg-[#191831] border border-[#2A2947] p-16 text-center">
        <h2 class="heading-font text-3xl leading-none mb-2">NO POST</h2>
        <p class="opacity-70">Nobody has said anything yet...</p>
      </div>
    {% endif %}

    <!-- Posts -->
    <div class="space-y-6" id="forum-posts">
      {% for post in posts %}
      <article id="post-{{ post.id }}" class="relative rounded-2xl bg-[#242244] border border-[#2A2947] p-6 pb-14">
        <!-- TOP ROW -->
        <div class="flex items-start gap-4">
          <div class="w-14 h-14 rounded-full bg-[#2A2947] border border-[#3A3960] flex items-center justify-center text-2xl">ðŸ‘¤</div>
          <div class="flex-1 min-w-0">
            <div class="heading-font text-lg text-[#D3B53E] leading-none truncate">
              {{ post.author.username }}
            </div>
            <p class="mt-2 leading-relaxed text-[#E7E7F2] break-words">
              {{ post.content }}
            </p>
          </div>
        </div>

        <!-- FOOTER: vote pill + timestamp + delete -->
        <div class="absolute right-6 bottom-4 flex items-center gap-4">

          <!-- VOTE PILL -->
          <span class="inline-flex items-center gap-1 rounded-full px-2 py-1 bg-[#F5F6FF] text-[#0E0E1F] border border-[#D5D7EC] shadow-sm">

            <!-- UPVOTE -->
            <form action="{% url 'forum:upvote' post.id %}" method="post" class="inline-flex" aria-label="Upvote {{ post.id }}">
              {% csrf_token %}
              <button
                aria-pressed="{% if post.user_vote_value == 1 %}true{% else %}false{% endif %}"
                class="group inline-flex justify-center items-center aspect-square p-0 border-0
                       hover:text-[#3730A3] focus-visible:text-[#3730A3]
                       {% if post.user_vote_value == 1 %}text-[#3730A3]{% endif %}"
                style="height: 28px; width: 28px">
                <span class="flex mx-1">
                  <svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 19a3.966 3.966 0 01-3.96-3.962V10.98H2.838a1.731 1.731 0 01-1.605-1.073 1.734 1.734 0 01.377-1.895L9.364.254a.925.925 0 011.272 0l7.754 7.759c.498.499.646 1.242.376 1.894-.27.652-.9 1.073-1.605 1.073h-3.202v4.058A3.965 3.965 0 019.999 19H10zM2.989 9.179H7.84v5.731c0 1.13.81 2.163 1.934 2.278a2.163 2.163 0 002.386-2.15V9.179h4.851L10 2.163 2.989 9.179z"></path>
                  </svg>
                </span>
                <span class="sr-only">Upvote</span>
              </button>
            </form>

            <!-- SCORE -->
            <span class="heading-font text-sm px-1 select-none">{{ post.score }}</span>

            <!-- DOWNVOTE -->
            <form action="{% url 'forum:downvote' post.id %}" method="post" class="inline-flex" aria-label="Downvote {{ post.id }}">
              {% csrf_token %}
              <button
                aria-pressed="{% if post.user_vote_value == -1 %}true{% else %}false{% endif %}"
                class="group inline-flex justify-center items-center aspect-square p-0 border-0
                       hover:text-[#ff3b3b] focus-visible:text-[#ff3b3b]
                       {% if post.user_vote_value == -1 %}text-[#ff3b3b]{% endif %}"
                style="height: 28px; width: 28px">
                <span class="flex mx-1">
                  <svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 1a3.966 3.966 0 013.96 3.962V9.02h3.202c.706 0 1.335.42 1.605 1.073.27.652.122 1.396-.377 1.895l-7.754 7.759a.925.925 0 01-1.272 0l-7.754-7.76a1.734 1.734 0 01-.376-1.894c.27-.652.9-1.073 1.605-1.073h3.202V4.962A3.965 3.965 0 0110 1zm7.01 9.82h-4.85V5.09c0-1.13-.81-2.163-1.934-2.278a2.163 2.163 0 00-2.386 2.15v5.859H2.989l7.01 7.016 7.012-7.016z"></path>
                  </svg>
                </span>
                <span class="sr-only">Downvote</span>
              </button>
            </form>
          </span>

          <!-- Timestamp (pakai local_created kalau ada) -->
          <div class="text-xs text-[#D3B53E] whitespace-nowrap">
            {% if post.local_created %}
              {{ post.local_created|date:"g:i A Â· M d, Y" }}
            {% else %}
              {{ post.created_at|date:"g:i A Â· M d, Y" }}
            {% endif %}
          </div>

          <!-- Delete (AJAX) -->
          {% if request.user.is_authenticated %}
            {% if request.user.is_staff or request.user.id == post.author_id %}
              <form action="{% url 'forum:delete_post' post.id %}" method="post" class="js-delete inline-flex">
                {% csrf_token %}
                <button type="button" class="js-delete-btn inline-flex items-center gap-2 rounded-full px-4 py-1.5 bg-transparent text-[#E7E7F2] border border-[#3A3960] hover:bg-[#2A2947] transition">
                  Delete
                </button>
              </form>
            {% endif %}
          {% endif %}
        </div>
      </article>
      {% endfor %}
    </div>

  </div>
</div>

{% if request.user.is_authenticated %}
<!-- Modal create post -->
<div id="postModal" class="fixed inset-0 hidden flex items-center justify-center">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative z-10 w-full max-w-xl rounded-2xl border border-[#2A2947] p-6 bg-[#191831] text-white">
    <h3 class="heading-font text-2xl text-center leading-none text-[#D3B53E]">TELL US YOUR STORY</h3>
    <p class="text-center opacity-70 mt-2 mb-4">What stories do you have right now?</p>

    <form action="{% url 'forum:create_post' %}" method="post" class="space-y-3">
      {% csrf_token %}
      <textarea name="content" rows="5" class="w-full rounded-xl border border-[#3A3960] bg-[#111024] text-white p-3 focus:outline-none" placeholder="Write your thoughts here..." required></textarea>
      <div class="flex justify-end gap-3 pt-2">
        <button type="button" id="closeModal" class="heading-font px-5 py-2 rounded-md border border-[#3A3960] hover:bg-[#2A2947] transition">CANCEL</button>
        <button class="heading-font px-5 py-2 rounded-md bg-[#D3B53E] text-[#111024] shadow hover:brightness-110 transition">POST</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<!-- Modal konfirmasi delete -->
<div id="confirmDelete" class="fixed inset-0 hidden items-center justify-center">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative z-50 w-[320px] rounded-xl border border-[#2A2947] bg-[#191831] text-white p-5">
    <div class="heading-font text-lg mb-2">Delete post?</div>
    <p class="text-sm opacity-75">This action cannot be undone.</p>
    <div class="mt-5 flex justify-end gap-2">
      <button id="confirmCancel" class="px-4 py-2 rounded border border-[#3A3960] hover:bg-[#2A2947]">Cancel</button>
      <button id="confirmOk" class="heading-font px-4 py-2 rounded bg-[#D3B53E] text-[#111024]">Delete</button>
    </div>
  </div>
</div>

<script>
  // --- ADD MODAL ---
  const modal = document.getElementById('postModal');
  const openBtn = document.getElementById('openModal');
  const closeBtn = document.getElementById('closeModal');

  function openModal() {
    if (!modal) return;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }
  function closeModal() {
    if (!modal) return;
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.style.overflow = '';
  }

  if (openBtn) openBtn.addEventListener('click', openModal);
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (modal) modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

  // --- SIMPLE TOAST (fallback kalau gak ada komponen toast bawaan) ---
  function showToast(msg) {
    if (window.showToast) { window.showToast(msg); return; }
    let t = document.getElementById('__toast');
    if (!t) {
      t = document.createElement('div');
      t.id = '__toast';
      t.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded shadow z-50 transition-opacity';
      t.style.opacity = 0;
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity = 1;
    setTimeout(() => t.style.opacity = 0, 1500);
  }

  // --- DELETE via AJAX + Modal Confirm ---
  const confirmWrap = document.getElementById('confirmDelete');
  const confirmOk = document.getElementById('confirmOk');
  const confirmCancel = document.getElementById('confirmCancel');
  let pendingForm = null;

  document.querySelectorAll('.js-delete-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      pendingForm = e.currentTarget.closest('form.js-delete');
      confirmWrap.classList.remove('hidden');
      confirmWrap.classList.add('flex');
    });
  });

  function closeConfirm() {
    confirmWrap.classList.add('hidden');
    confirmWrap.classList.remove('flex');
  }
  if (confirmCancel) confirmCancel.addEventListener('click', closeConfirm);
  if (confirmWrap) confirmWrap.addEventListener('click', e => { if (e.target === confirmWrap) closeConfirm(); });

  function csrfFrom(form) {
    const input = form.querySelector('input[name="csrfmiddlewaretoken"]');
    return input ? input.value : '';
  }

  if (confirmOk) {
    confirmOk.addEventListener('click', async () => {
      if (!pendingForm) return closeConfirm();
      const form = pendingForm; pendingForm = null;
      closeConfirm();

      const url = form.action;
      const csrf = csrfFrom(form);
      const article = form.closest('article');

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrf, 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) throw new Error('Request failed');
        const data = await res.json();
        if (data.ok) {
          article.style.transition = 'opacity .2s, transform .2s';
          article.style.opacity = '0';
          article.style.transform = 'scale(0.98)';
          setTimeout(() => article.remove(), 180);
          showToast('Post deleted');
        } else {
          showToast(data.error || 'Failed to delete');
        }
      } catch {
        showToast('Network error');
      }
    });
  }
</script>
{% endblock %}
