{% extends "base.html" %}
{% block title %}Forum | KuLatih{% endblock %}
{% block content %}

<div class="min-h-[80vh] bg-[var(--indigo)] text-[var(--white)]">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 space-y-6">

        <!-- HEADER -->
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
        <div>
            <h1 class="heading-font text-5xl sm:text-6xl leading-none px-1 text-[var(--yellow)]">FORUM</h1>
            <span class="heading-font inline-block mt-2 ml-1 text-lg sm:text-xl px-3 py-1 rounded tracking-wide
                        bg-[var(--white)] text-[var(--indigo-dark)]">
            SHARE YOUR THOUGHTS
            </span>
        </div>

        <div class="sm:self-end">
            {% if request.user.is_authenticated %}
                <button id="openModal"
                class="heading-font w-full sm:w-auto
                        inline-flex items-center justify-center gap-2
                        px-7 sm:px-8 py-3 sm:py-3.5
                        text-xl sm:text-2xl font-extrabold tracking-wide
                        rounded-xl bg-[var(--yellow)] text-[var(--indigo-dark)]
                        shadow-lg hover:brightness-110
                        ring-2 ring-[var(--yellow)]/20 hover:ring-[var(--yellow)]/30
                        focus:outline-none focus-visible:ring-4 focus-visible:ring-[var(--yellow)]/40
                        transition">
                <!-- icon plus -->
                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M11 5h2v14h-2zM5 11h14v2H5z"/>
                </svg>
                ADD POST
                </button>
            {% else %}
            <a href="{% url 'users:login' %}"
                class="heading-font w-full sm:w-auto inline-block px-5 py-2 rounded-md bg-[var(--yellow)] text-[var(--indigo-dark)]
                        shadow hover:brightness-110 transition">
                LOGIN TO POST
            </a>
            {% endif %}
        </div>
        </div>

        <!-- LIST POSTS -->
        <div id="forum-posts" class="space-y-6">
        {% for post in posts %}
        <article id="post-{{ post.id }}"
                class="relative rounded-2xl bg-[var(--indigo-light)] border border-[var(--indigo-light)]
                        p-4 sm:p-6 pb-16 sm:pb-14">

            <!-- ROW: avatar + author/content -->
            <div class="flex items-start gap-3 sm:gap-4">
            <!-- avatar + username jadi satu div -->
            <div class="flex-shrink-0">
                <div class="w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-[var(--indigo-light)]
                            flex items-center justify-center text-xl sm:text-2xl
                            ring-1 ring-[rgb(245_245_245/0.25)] hover:ring-[rgb(245_245_245/0.4)]">
                ðŸ‘¤
                </div>
            </div>

            <div class="flex-1 min-w-0">
                <div class="heading-font text-base sm:text-lg text-[var(--yellow)] leading-none truncate">
                {{ post.author.username }}
                </div>

                <!-- isi post satu kolom -->
                <p class="mt-2 leading-relaxed text-[var(--white)]/90 break-words body-font mb-5">
                {{ post.content }}
                </p>
            </div>
            </div>

            <!-- FOOTER: vote + score + timestamp + edit + delete (satu group) -->
            <div class="absolute left-4 right-4 sm:left-auto sm:right-6 bottom-3 sm:bottom-4
                        flex flex-wrap items-center gap-3 sm:gap-4 justify-between sm:justify-end">

            <!-- LEFT (on small): VOTE PILL -->
            <span class="order-1 sm:order-none inline-flex items-center gap-3 rounded-full px-3 sm:px-4 py-1.5
                        bg-[var(--white)] text-[var(--indigo-dark)]
                        ring-1 ring-[rgb(0_0_0/0.08)] shadow-sm select-none">

                <!-- UPVOTE (AJAX) -->
                <form action="{% url 'forum:upvote' post.id %}" method="post"
                    class="inline-flex js-vote" data-post-id="{{ post.id }}" data-role="up">
                {% csrf_token %}
                <button type="button" class="js-vote-btn group inline-flex items-center justify-center h-7 w-7 rounded">
                    <!-- solid (aktif) -->
                    <svg class="icon-solid {% if post.user_vote_value != 1 %}hidden{% endif %}"
                        viewBox="0 0 20 20" width="20" height="20" fill="currentColor">
                    <path d="M10 19a3.966 3.966 0 01-3.96-3.962V10.98H2.838a1.731 1.731 0 01-1.605-1.073 1.734 1.734 0 01.377-1.895L9.364.254a.925.925 0 011.272 0l7.754 7.759c.498.499.646 1.242.376 1.894-.27.652-.9 1.073-1.605 1.073h-3.202v4.058A3.965 3.965 0 019.999 19H10z"/>
                    </svg>
                    <!-- outline (non-aktif) -->
                    <svg class="icon-outline {% if post.user_vote_value == 1 %}hidden{% endif %}
                                text-[rgb(0_0_0/0.45)] group-hover:text-[var(--indigo-dark)]"
                        viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor"
                        stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 3l7 7h-4v6a3 3 0 0 1-6 0V10H5l7-7z"/>
                    </svg>
                    <span class="sr-only">Upvote</span>
                </button>
                </form>

                <!-- SCORE -->
                <span class="body-font text-base js-score" id="score-{{ post.id }}">{{ post.score }}</span>

                <!-- DOWNVOTE (AJAX) -->
                <form action="{% url 'forum:downvote' post.id %}" method="post"
                    class="inline-flex js-vote" data-post-id="{{ post.id }}" data-role="down">
                {% csrf_token %}
                <button type="button" class="js-vote-btn group inline-flex items-center justify-center h-7 w-7 rounded">
                    <!-- solid (aktif) -->
                    <svg class="icon-solid {% if post.user_vote_value != -1 %}hidden{% endif %}"
                        viewBox="0 0 20 20" width="20" height="20" fill="currentColor">
                    <path d="M10 1a3.966 3.966 0 013.96 3.962V9.02h3.202c.706 0 1.335.42 1.605 1.073.27.652.122 1.396-.377 1.895l-7.754 7.759a.925.925 0 01-1.272 0l-7.754-7.76a1.734 1.734 0 01-.376-1.894c.27-.652.9-1.073 1.605-1.073h3.202V4.962A3.965 3.965 0 0110 1z"/>
                    </svg>
                    <!-- outline (non-aktif) -->
                    <svg class="icon-outline {% if post.user_vote_value == -1 %}hidden{% endif %}
                                text-[rgb(0_0_0/0.45)] group-hover:text-[var(--indigo-dark)]"
                        viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor"
                        stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 21l-7-7h4V8a3 3 0 0 1 6 0v6h4l-7 7z"/>
                    </svg>
                    <span class="sr-only">Downvote</span>
                </button>
                </form>
            </span>

            <!-- RIGHT group: timestamp + edit + delete -->
            <div class="order-2 sm:order-none flex items-center gap-2 sm:gap-3">

                <!-- Created -->
                <div class="text-xs sm:text-sm text-[var(--yellow)] whitespace-nowrap body-font">
                {% if post.local_created %}
                    {{ post.local_created|date:"g:i A Â· M d, Y" }}
                {% else %}
                    {{ post.created_at|date:"g:i A Â· M d, Y" }}
                {% endif %}
                </div>

                <!-- EDIT (AJAX) -->
                {% if request.user.is_authenticated %}
                {% if request.user.is_staff or request.user.id == post.author_id %}
                    <button type="button"
                            class="js-edit-btn inline-flex items-center gap-2 rounded-full px-3 sm:px-4 py-1.5
                                bg-transparent text-[var(--white)]/90
                                border border-[rgb(245_245_245/0.25)]
                                hover:border-[rgb(245_245_245/0.45)]
                                hover:bg-[var(--indigo-light)] transition"
                            data-id="{{ post.id }}"
                            data-url="{% url 'forum:edit_post' post.id %}"
                            data-content="{{ post.content|escapejs }}">
                    Edit
                    </button>
                {% endif %}
                {% endif %}

                <!-- DELETE (AJAX + confirm) -->
                {% if request.user.is_authenticated %}
                {% if request.user.is_staff or request.user.id == post.author_id %}
                    <form action="{% url 'forum:delete_post' post.id %}" method="post" class="js-delete inline-flex">
                    {% csrf_token %}
                    <button type="button"
                            class="js-delete-btn inline-flex items-center gap-2 rounded-full px-3 sm:px-4 py-1.5
                                    bg-transparent text-[var(--white)]/90
                                    border border-[rgb(245_245_245/0.25)]
                                    hover:border-[rgb(245_245_245/0.45)]
                                    hover:bg-[var(--indigo-light)] transition">
                        Delete
                    </button>
                    </form>
                {% endif %}
                {% endif %}
            </div>
            </div>
        </article>
        {% empty %}
        <!-- Empty state di dalam for/empty -->
        <div class="rounded-2xl bg-[var(--indigo)] border border-[var(--indigo-light)] p-16 text-center">
            <h2 class="heading-font text-3xl leading-none mb-2">NO POST</h2>
            <p class="opacity-70">Nobody has said anything yet...</p>
        </div>
        {% endfor %}
        </div>

    </div>
    </div>

    {% if request.user.is_authenticated %}
    <!-- MODAL: Create Post -->
    <div id="postModal" class="fixed inset-0 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative z-10 w-full max-w-xl rounded-2xl border border-[var(--indigo-light)]
                p-6 bg-[var(--indigo)] text-[var(--white)]">
        <h3 class="heading-font text-2xl text-center leading-none text-[var(--yellow)]">TELL US YOUR STORY</h3>
        <p class="text-center opacity-70 mt-2 mb-4">What stories do you have right now?</p>

        <form action="{% url 'forum:create_post' %}" method="post" class="space-y-3">
        {% csrf_token %}
        <textarea name="content" rows="5"
                    class="w-full rounded-xl border border-[var(--indigo-dark)]
                        bg-[var(--indigo-dark)] text-[var(--white)] p-3 focus:outline-none"
                    placeholder="Write your thoughts here..." required></textarea>
        <div class="flex justify-end gap-3 pt-2">
            <button type="button" id="closeModal"
                    class="heading-font px-5 py-2 rounded-md border border-[var(--indigo-dark)]
                        hover:bg-[var(--indigo-light)] transition">
            CANCEL
            </button>
            <button class="heading-font px-5 py-2 rounded-md bg-[var(--yellow)] text-[var(--indigo-dark)]
                        shadow hover:brightness-110 transition">
            POST
            </button>
        </div>
        </form>
    </div>
    </div>
    {% endif %}

    <!-- MODAL: Confirm Delete -->
    <div id="confirmDelete" class="fixed inset-0 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative z-50 w-[320px] rounded-xl border border-[var(--indigo-light)]
                bg-[var(--indigo)] text-[var(--white)] p-5">
        <div class="heading-font text-lg mb-2">Delete post?</div>
        <p class="text-sm opacity-75">This action cannot be undone.</p>
        <div class="mt-5 flex justify-end gap-2">
        <button id="confirmCancel" class="px-4 py-2 rounded border border-[var(--indigo-dark)]
                                        hover:bg-[var(--indigo-light)]">Cancel</button>
        <button id="confirmOk" class="heading-font px-4 py-2 rounded bg-[var(--yellow)] text-[var(--indigo-dark)]">Delete</button>
        </div>
    </div>
    </div>

    <!-- MODAL: Edit Post -->
    <div id="editModal" class="fixed inset-0 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative z-50 w-full max-w-xl rounded-2xl border border-[var(--indigo-light)]
                bg-[var(--indigo)] text-[var(--white)] p-5">
        <h3 class="heading-font text-xl mb-3 text-[var(--yellow)]">Edit Post</h3>
        <form id="editForm" method="post" class="space-y-3">
        {% csrf_token %}
        <textarea id="editContent" name="content" rows="5"
                    class="w-full rounded-xl border border-[var(--indigo-dark)]
                        bg-[var(--indigo-dark)] text-[var(--white)] p-3 focus:outline-none"
                    required></textarea>
        <div class="flex justify-end gap-2">
            <button type="button" id="editCancel"
                    class="px-4 py-2 rounded border border-[var(--indigo-dark)]
                        hover:bg-[var(--indigo-light)]">Cancel</button>
            <button type="submit"
                    class="heading-font px-4 py-2 rounded bg-[var(--yellow)] text-[var(--indigo-dark)]">Save</button>
        </div>
        </form>
    </div>
    </div>

    <script>
    /* ---------- ADD MODAL ---------- */
    const modal = document.getElementById('postModal');
    const openBtn = document.getElementById('openModal');
    const closeBtn = document.getElementById('closeModal');

    function openModal() {
        if (!modal) return;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }
    function closeModal() {
        if (!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
    }

    if (openBtn) openBtn.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (modal) modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

    /* ---------- SIMPLE TOAST (fallback) ---------- */
    function showToast(msg) {
        if (window.showToast) { window.showToast(msg); return; }
        let t = document.getElementById('__toast');
        if (!t) {
        t = document.createElement('div');
        t.id = '__toast';
        t.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded shadow z-50 transition-opacity';
        t.style.background = 'var(--indigo-dark)';
        t.style.color = 'var(--white)';
        t.style.opacity = 0;
        document.body.appendChild(t);
        }
        t.textContent = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 1500);
    }

    /* ---------- DELETE via AJAX + Confirm ---------- */
    const confirmWrap = document.getElementById('confirmDelete');
    const confirmOk = document.getElementById('confirmOk');
    const confirmCancel = document.getElementById('confirmCancel');
    let pendingForm = null;

    document.querySelectorAll('.js-delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
        pendingForm = e.currentTarget.closest('form.js-delete');
        confirmWrap.classList.remove('hidden');
        confirmWrap.classList.add('flex');
        });
    });

    function closeConfirm() {
        confirmWrap.classList.add('hidden');
        confirmWrap.classList.remove('flex');
    }
    if (confirmCancel) confirmCancel.addEventListener('click', closeConfirm);
    if (confirmWrap) confirmWrap.addEventListener('click', e => { if (e.target === confirmWrap) closeConfirm(); });

    function csrfFrom(form) {
        const input = form.querySelector('input[name="csrfmiddlewaretoken"]');
        return input ? input.value : '';
    }

    if (confirmOk) {
        confirmOk.addEventListener('click', async () => {
        if (!pendingForm) return closeConfirm();
        const form = pendingForm; pendingForm = null;
        closeConfirm();

        const url = form.action;
        const csrf = csrfFrom(form);
        const article = form.closest('article');

        try {
            const res = await fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrf, 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!res.ok) throw new Error('Request failed');
            const data = await res.json();
            if (data.ok) {
            article.style.transition = 'opacity .2s, transform .2s';
            article.style.opacity = '0';
            article.style.transform = 'scale(0.98)';
            setTimeout(() => article.remove(), 180);
            showToast('Post deleted');
            } else {
            showToast(data.error || 'Failed to delete');
            }
        } catch {
            showToast('Network error');
        }
        });
    }

    /* ---------- VOTE AJAX (NO RELOAD) ---------- */
    function getCsrf(form){ const i=form.querySelector('input[name="csrfmiddlewaretoken"]'); return i?i.value:''; }
    function setActiveIcons(form, isActive){
        const solid = form.querySelector('.icon-solid');
        const outline = form.querySelector('.icon-outline');
        if (!solid || !outline) return;
        if (isActive){ solid.classList.remove('hidden'); outline.classList.add('hidden'); }
        else { solid.classList.add('hidden'); outline.classList.remove('hidden'); }
    }

    document.querySelectorAll('form.js-vote .js-vote-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
        const form = e.currentTarget.closest('form.js-vote');
        const csrf = getCsrf(form);
        const postId = form.dataset.postId;

        try {
            const res = await fetch(form.action, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrf, 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!res.ok) throw new Error('Bad response');
            const data = await res.json();
            if (!data.ok) throw new Error('Vote failed');

            // update score
            const scoreEl = document.getElementById(`score-${postId}`);
            if (scoreEl) scoreEl.textContent = data.score;

            // toggle ikon dua sisi
            const pill = form.closest('span');
            const upForm = pill.querySelector('form.js-vote[data-role="up"]');
            const downForm = pill.querySelector('form.js-vote[data-role="down"]');
            setActiveIcons(upForm, data.user_vote === 1);
            setActiveIcons(downForm, data.user_vote === -1);
        } catch (err) {
            console.error(err);
            showToast('Failed to vote');
        }
        });
    });

    /* ---------- EDIT (OPEN MODAL + SUBMIT AJAX) ---------- */
    const editModal = document.getElementById('editModal');
    const editCancel = document.getElementById('editCancel');
    const editForm = document.getElementById('editForm');
    const editContent = document.getElementById('editContent');
    let editTargetId = null;
    let editUrl = null;

    function openEdit() {
        editModal.classList.remove('hidden');
        editModal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }
    function closeEdit() {
        editModal.classList.add('hidden');
        editModal.classList.remove('flex');
        document.body.style.overflow = '';
        editTargetId = null; editUrl = null; editContent.value = '';
    }

    document.querySelectorAll('.js-edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
        editTargetId = btn.dataset.id;
        editUrl = btn.dataset.url;
        editContent.value = btn.dataset.content || '';
        openEdit();
        });
    });
    if (editCancel) editCancel.addEventListener('click', closeEdit);
    if (editModal) editModal.addEventListener('click', e => { if (e.target === editModal) closeEdit(); });

    if (editForm) {
        editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!editUrl) return closeEdit();
        const formData = new FormData(editForm);
        try{
            const res = await fetch(editUrl, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
            });
            if(!res.ok) throw new Error('Bad response');
            const data = await res.json();
            if(!data.ok) throw new Error('Update failed');

            // update isi di kartu
            const article = document.getElementById(`post-${editTargetId}`);
            const paragraph = article ? article.querySelector('p') : null;
            if(paragraph) paragraph.textContent = data.content || formData.get('content');

            // simpan content baru ke tombol Edit
            const editBtn = article ? article.querySelector('.js-edit-btn') : null;
            if (editBtn) editBtn.dataset.content = data.content || formData.get('content');

            closeEdit();
            showToast('Post updated');
        }catch{
            showToast('Failed to update');
        }
        });
    }
</script>

{% endblock %}
